pipeline {
  agent any
  environment {
    DOCKERHUB_CREDENTIALS = 'dockerhub-creds'  
    BACKEND_IMAGE         = 'yasser2003/waterwise-backend'
    FRONTEND_IMAGE        = 'yasser2003/waterwise-frontend'
  }
  stages {

    stage('Docker Login') {
      steps {
        withCredentials([usernamePassword(credentialsId: env.DOCKERHUB_CREDENTIALS, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh 'echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin'
        }
      }
    }

    stage('Build & Push') {
      steps {
        dir('WaterWise_app') {
          // 1) build both services
          sh 'docker compose build --pull'

          // 2) push them up by service name
          sh 'docker compose push backend'
          sh 'docker compose push frontend'
        }
      }
    }
    
    stage('Cleanup') {
      steps {
        sh 'docker logout'
        sh 'docker rmi yourdockerhubuser/waterwise-backend:latest yourdockerhubuser/waterwise-frontend:latest || true'
      }
    }
  }

  post {
    always {
      echo 'Pipeline finished.'
    }
    failure {
      echo 'One or more stages failed.'
    }
  }
}
